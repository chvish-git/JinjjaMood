rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Users collection - using UID as document ID
    match /users/{userId} {
      // Allow reading own profile
      allow read: if request.auth != null && request.auth.uid == userId;
      
      // Allow creating own profile during signup
      allow create: if request.auth != null && 
                    request.auth.uid == userId &&
                    request.resource.data.username is string &&
                    request.resource.data.username.size() >= 2 &&
                    request.resource.data.username.size() <= 20 &&
                    request.resource.data.username.matches('^[a-z0-9_]+$') &&
                    request.resource.data.email is string &&
                    request.resource.data.email.matches('^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$') &&
                    request.resource.data.createdAt != null;
      
      // Allow updating own profile
      allow update: if request.auth != null && 
                    request.auth.uid == userId &&
                    request.resource.data.username is string &&
                    request.resource.data.username.size() >= 2 &&
                    request.resource.data.username.size() <= 20 &&
                    request.resource.data.username.matches('^[a-z0-9_]+$') &&
                    request.resource.data.email is string &&
                    request.resource.data.email.matches('^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$');
      
      // Allow deleting own profile
      allow delete: if request.auth != null && request.auth.uid == userId;
    }
    
    // Username reservations collection - for checking username availability
    match /usernames/{username} {
      // Allow reading for username uniqueness checks
      allow read: if request.auth != null;
      
      // Allow creating username reservation during signup
      allow create: if request.auth != null && 
                    request.resource.data.uid == request.auth.uid;
      
      // Allow updating own username reservation
      allow update: if request.auth != null && 
                    request.resource.data.uid == request.auth.uid;
      
      // Allow deleting own username reservation
      allow delete: if request.auth != null && 
                    resource.data.uid == request.auth.uid;
    }
    
    // Mood logs collection - secure per-user access with expanded mood validation
    match /moodLogs/{logId} {
      // Allow reading individual mood log documents (get operations)
      allow get: if request.auth != null && 
                 resource.data.uid == request.auth.uid;
      
      // Allow listing mood logs only when querying by user's own uid
      allow list: if request.auth != null && 
                  request.query.where.uid['=='] == request.auth.uid;
      
      // Allow writing only own mood logs with validation for new expanded moods
      allow write: if request.auth != null && 
                   request.resource.data.uid == request.auth.uid &&
                   request.resource.data.mood is string &&
                   request.resource.data.mood in [
                     // Positive moods
                     'joyful', 'productive', 'calm', 'grateful', 'energized', 'confident',
                     // Neutral moods
                     'meh', 'blank', 'tired', 'chill', 'focused', 'neutral',
                     // Negative moods
                     'anxious', 'angry', 'stressed', 'low energy', 'overwhelmed', 'sad',
                     // Bonus moods
                     'ungovernable', 'CEO mode', 'fluff cloud', 'main character', 'chaos gremlin', 'soft launch'
                   ] &&
                   request.resource.data.moodType is string &&
                   request.resource.data.moodType in ['positive', 'neutral', 'negative', 'bonus'] &&
                   request.resource.data.journalEntry is string &&
                   request.resource.data.timestamp != null &&
                   request.resource.data.day is string &&
                   request.resource.data.hour is number &&
                   request.resource.data.hour >= 0 &&
                   request.resource.data.hour <= 23;
    }
  }
}