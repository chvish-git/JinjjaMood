rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Users collection - using username as document ID with public read access
    match /users/{username} {
      // Allow reading any user profile (public usernames)
      allow read: if request.auth != null;
      
      // Allow writing only if the authenticated user's UID matches the document's uid field
      allow write: if request.auth != null && request.auth.uid == request.resource.data.uid;
    }
    
    // Mood logs collection - secure per-user access with expanded mood validation
    match /moodLogs/{logId} {
      // Allow reading individual mood log documents (get operations)
      allow get: if request.auth != null && 
                 resource.data.uid == request.auth.uid;
      
      // Allow listing mood logs only when querying by user's own uid
      allow list: if request.auth != null && 
                  resource.data.uid == request.auth.uid;
      
      // Allow writing only own mood logs with validation for new expanded moods
      allow write: if request.auth != null && 
                   request.resource.data.uid == request.auth.uid &&
                   request.resource.data.mood is string &&
                   request.resource.data.mood in [
                     // Positive moods
                     'joyful', 'productive', 'calm', 'grateful', 'energized', 'confident',
                     // Neutral moods
                     'meh', 'blank', 'tired', 'chill', 'focused', 'neutral',
                     // Negative moods
                     'anxious', 'angry', 'stressed', 'low energy', 'overwhelmed', 'sad',
                     // Bonus moods
                     'ungovernable', 'CEO mode', 'fluff cloud', 'main character', 'chaos gremlin', 'soft launch'
                   ] &&
                   request.resource.data.moodType is string &&
                   request.resource.data.moodType in ['positive', 'neutral', 'negative', 'bonus'] &&
                   request.resource.data.journalEntry is string &&
                   request.resource.data.timestamp != null &&
                   request.resource.data.day is string &&
                   request.resource.data.hour is number &&
                   request.resource.data.hour >= 0 &&
                   request.resource.data.hour <= 23;
    }
  }
}