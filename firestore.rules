rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Users collection - secure per-user access with username uniqueness
    match /users/{userId} {
      // Allow reading any user profile (for username uniqueness checks)
      allow read: if true;
      
      // Allow writing only to own profile with validation
      allow write: if request.auth != null && 
                   request.auth.uid == userId &&
                   request.resource.data.username is string &&
                   request.resource.data.username.size() >= 2 &&
                   request.resource.data.username.size() <= 20 &&
                   request.resource.data.username.matches('^[a-z0-9_]+$') &&
                   request.resource.data.name is string &&
                   request.resource.data.createdAt != null;
    }
    
    // Mood logs collection - secure per-user access
    match /moodLogs/{logId} {
      // Allow reading only own mood logs
      allow read: if request.auth != null && 
                  resource.data.uid == request.auth.uid;
      
      // Allow writing only own mood logs with validation
      allow write: if request.auth != null && 
                   request.resource.data.uid == request.auth.uid &&
                   request.resource.data.mood is string &&
                   request.resource.data.mood in ['Sad', 'Neutral', 'Good', 'Stressed', 'Hyped'] &&
                   request.resource.data.journalEntry is string &&
                   request.resource.data.timestamp != null;
    }
  }
}